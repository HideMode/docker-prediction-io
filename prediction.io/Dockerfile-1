FROM java:8-jdk

ENV PIO_VERSION 0.12.1
ENV SPARK_VERSION 2.2.1
ENV ELASTICSEARCH_VERSION 5.5.2
ENV HBASE_VERSION 1.2.6.1
ENV PIO_HOME /prediction-io

RUN cp /etc/default/useradd /etc/default/useradd.bak \
  && echo "HOME=" >> /etc/default/useradd \
  && useradd --create-home --shell /usr/sbin/nologin prediction-io \
  && rm -rf /etc/default/useradd \
  && mv /etc/default/useradd.bak /etc/default/useradd \
  && rm /prediction-io/.bash_logout /prediction-io/.bashrc /prediction-io/.profile

ENV APACHE_SITE http://mirror.bit.edu.cn/apache 
# ENV APACHE_SITE http://www-us.apache.org/dist

USER prediction-io
WORKDIR /prediction-io

# download PIO source code and create vendors folder
RUN wget -O - ${APACHE_SITE}/predictionio/${PIO_VERSION}/apache-predictionio-${PIO_VERSION}-bin.tar.gz | tar zx && \
    mv PredictionIO* ${PIO_HOME} && \
    mkdir -p ${PIO_HOME}/vendors

#Spark INSTALLATION
RUN wget -O - ${APACHE_SITE}/spark/spark-${SPARK_VERSION}/spark-${SPARK_VERSION}-bin-hadoop2.7.tgz | tar zx && \
    mv spark* ${PIO_HOME}/vendors/spark

#ELASTICSEARCH INSTALLATION
RUN wget -O - https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-${ELASTICSEARCH_VERSION}.tar.gz | tar zx && \
    mv elasticsearch* ${PIO_HOME}/vendors/elasticsearch

ENV PATH $PIO_HOME/bin:$PATH \
    PATH $PIO_HOME/vendors/spark/bin:$PATH


#make dir and volume for models and universal recommended template
RUN mkdir -p ${PIO_HOME}/.pio_store/models
RUN mkdir -p ${PIO_HOME}/universal
VOLUME ["${PIO_HOME}/.pio_store"]
VOLUME ["${PIO_HOME}/universal"]
# Set the default command:
CMD ["pio", "eventserver"]
